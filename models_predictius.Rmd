---
title: 'StatWars: models predictius'
author: "Arnau Garcia"
date: "2024-10-14"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# StatWars: els meus primers models predictius

En aquesta activitat, us volem presentar una eina molt poderosa que utilitzem en estadística per entendre millor el món que ens envolta: els **models predictius**. Aquests models ens ajuden a predir què passarà en el futur a partir de dades que ja coneixem. A través de conceptes senzills com les **regressions lineals** i les **regressions lineals generalitzades**, veurem com podem utilitzar les matemàtiques per establir relacions entre diferents variables i fer prediccions amb aquestes. Descobrireu com la combinació d'estadística i matemàtiques ens pot ajudar a prendre decisions basades en dades, d'una manera més informada i precisa.

Aquest document serveix com a exemple de com ajustar dos models predictius fent servir el llenguatge de programació **R**. **R**, <https://es.wikipedia.org/wiki/R\_(lenguaje_de_programaci%C3%B3n)>, és el principal llenguatge de programació pels estadístics. Es tracta d'un software lliure, gratuït que es troba a l'abast de tothom.

Veurem dos models predictius:

- Predicció de preus d'immobles. 
- Predicció d'espècies de pingüins.

## Predicció de preus d'inmobles

En aquest primer model volem predir el preu de les cases de la ciutat de Ames, a Iowa. Farem servir una base de dades amb dades reals sobre inmobles en aquesta ciutat dels Estats Units. Podeu trobar informació sobre la base de dades original a <https://www.openintro.org/data/index.php?data=ames>.Farem servir la següent taula de dades per entrenar el nostre primer model predictiu:

```{r}
cases_train <- read.csv("cases_train.csv")
cases_train$X <- NULL
head(cases_train)
```

En aquesta base de dades tenim informació sobre 2842 vivendes, per cadascuna tenim 10 variables. Les variables que tenim en aquesta taula són:

* `preu`: preu de l'habitatge.
* `area`: àrea de la vivenda (en peus quadrats).
* `qual.total`: valora de l'1 al 10 el material i el acabat general de l'habitatge.
* `condicio.total`: valora de l'1 al 10 l'estat general de l'habitatge.
* `any`: any de construcció de la vivenda.
* `carrer`: tipus de carrer que dona accés a l'inmoble.
* `tipus`: tipus d'habitatge. 
* `garatge.cotxes`: número de cotxes que hi caben en el garatge.
* `garatge.area`: àrea del garatge (en peus quadrats).
* `aire`: variable que indica si la vivenda té aire condicionat (Y si en té, N si no). 

Observeu que tenim cinc variables numèriques (`preu`, `area`, `any`, `garatge.area`, `garatge.cotxes`), i quatre variables cinc variables categòriques (`qual.total`, `condicio.total`, `carrer`, `tipus`, `aire`). 

Fem una exploració de les dades a través de diferents gràfics que ens ajudaran a saber com es comporten les nostres variables amb respecte la variable que volem predir (`preu`).

```{r}
library(ggplot2)
ggplot(data = cases_train) +
  geom_point(aes(x = area, y = preu), color = "tomato")
ggplot(data = cases_train) +
  geom_point(aes(x = qual.total, y = preu), color = "skyblue")
ggplot(data = cases_train) +
  geom_point(aes(x = condicio.total, y = preu), color = "darkorange")
ggplot(data = cases_train) +
  geom_point(aes(x = any, y = preu), color = "blueviolet")
ggplot(data = cases_train) +
  geom_boxplot(aes(x = carrer, y = preu), color = "cyan")
ggplot(data = cases_train) +
  geom_boxplot(aes(x = tipus, y = preu), color = "coral4")
ggplot(data = cases_train) +
  geom_point(aes(x = garatge.cotxes, y = preu), color = "blue")
ggplot(data = cases_train) +
  geom_point(aes(x = garatge.area, y = preu), color = "chartreuse3")
ggplot(data = cases_train) +
  geom_boxplot(aes(x = aire, y = preu), color = "deepskyblue3")
```

Conclusions sobre els gràfics:

* Com més àrea té, més car l'habitatge.
* Com més qualitat total té l'inmoble, més car.
* Sembla que en general, com millor condició general, més car.
* Sembla que la tendència respecte l'any de construcció és: més nou, més car.
* Els habitatges amb carrer tipus `Pave` son més cars que els tipus `Grvl`.
* Sembla que les cases unifamiliars són més cares que les altres.
* En general, sembla que com més cotxes hi caben en el garatge, més car l'habitatge.
* Com més àrea té el garatge, més car l'habitatge.
* Sembla que aquells habitatges amb aire condicionat són més cars.

Ajustem un model lineal:

```{r}
model.lineal <- lm(preu ~ area + qual.total + condicio.total + any + tipus + 
           garatge.area + aire, data = cases_train)
summary(model.lineal)
```

Ara, descarreguem una taula de dades que teniem guardada apart. En aquesta taula de dades hi ha dades noves sobre el problema que estem tractant, aquestes dades no s'han fet servir per entrenar el nostre model. El que farem amb aquestes noves dades és testejar el nostre model i veure si és capaç de fer bones prediccions.

Llegim les noves dades:

```{r}
cases_test <- read.csv("cases_test.csv")
cases_test$X <- NULL
head(cases_test)
```

En aquestes noves dades tenim informació sobre 88 habitatges d'Ames. A continuació, fem prediccions amb el model que hem ajustat anteriorment, i veiem si aquestes prediccions s'acosten al valor real de les noves dades:

```{r}
preds <- predict(model.lineal, newdata = cases_test)
comparison <- data.frame(Real = cases_test$preu, Predit = preds,
                         Difer = abs(cases_test$preu - preds))
head(comparison, 10)
```

Només estem ensenyant 10 resultats de les 88 prediccions que hem fet. Com podeu veure el nostre model només s'equivoca predint el preu real de l'habitatge per 750 dòlars (en una casa que costa 127mil dòlars), 15mil dòlars (en una casa que costa 169mil dòlars), 6mil dòlars (en una casa que costa 132mil dòlars), 557 dòlars (en una casa que costa 143mil dòlars), etc. 

## Predicció d'espècies de pingüins

```{r}
penguins_test <- read.csv("penguins_test.csv")
penguins_train <- read.csv("https://vicpena.github.io/glm/datasets/penguins_train.csv")
# convert year and sex into factor
penguins_train$year <- factor(penguins_train$year)
penguins_train$sex <- factor(penguins_train$sex)
levels(penguins_train$sex)
penguins_train$year <- NULL
```


Some plots:

```{r}
ggplot(penguins_train) +
  geom_boxplot(aes(x=species, y=bill_length_mm))
ggplot(penguins_train)+
  geom_boxplot(aes(x=species, body_mass_g))
ggplot(penguins_train)+
  geom_boxplot(aes(x=species, y=bill_depth_mm))
ggplot(penguins_train)+
  geom_boxplot(aes(x=species, y=flipper_length_mm))
with(penguins_train, table(species, island))
ggplot(penguins_train)+
  geom_point(aes(x=bill_length_mm, y=bill_depth_mm, color=species))
```

We fit the glm:

```{r}
library(nnet)
mod <- step(multinom(species ~ . , data = penguins_train, trace = FALSE))
summary(mod)
```

Let us do predictions and confusion matrix:

```{r}
library(caret)
preds_train <- predict(mod, newdata = penguins_test)
confusionMatrix(preds_train, factor(penguins_test$species))
```

